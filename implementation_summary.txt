**実装過程サマリー (Historio Web版)**

**このプロジェクトはPythonで製作されたhistorio(h1$tor!0)をweb版として、ローカルでも動作するhtml+css+jsによる移植版を製作するものです。**

**【最重要！：修正および実装にあたっての注意事項】
*   **大前提！:**  現在問題なく動作しているPython版(以下py版)の実装を基本的に正とすること。修正や実装時にはこれを参考とすること。
    *   **追記：** ただしPROCESS_CARD_OPERATIONという汎用ハンドラの利用を積極的に行うことなど、JS版独自の調整も許容されている。
*   **これでよく止まる！:**  `replace` ツールは、特に `import` 文のようなファイルの先頭部分や、コードブロック全体を置き換える際には、意図しない重複や構文エラーを引き起こす可能性があるため、非常に慎重に使用するか、`write_file` でファイル全体を上書きする方が安全である。
*   **経験則！:**  ファイルの操作は、部分置き換えは上手くいかないことも多いので、全体を使った上書きを推奨する。
    *   **追記：** しかし、ファイル全体の置き換えをするつもりが、修正前と修正後を同ファイルに両方書いてしまうような場合もあるので、きちんと上書きをすること！
*   **これでよく止まる！!: ** `card_definitions.json` は3000行以上あるため、必ず人間が編集すること！そもそもpy版と同じ内容を使いまわせるっようにするため、重大な内容でない限り基本的にこれは書き換えない！
*   **遠回りしないために！:** テスト自体が誤っていることも少なくない。テストが失敗した場合、まずはテストファイルを確認すること！
*   **遠回りしないために！:** テスト内部でカード定義のモックを作成する場合、checkCardReactionでハードコーディングされた条件に掛かることがないらしく、conditionを評価する箇所に追加や修正を行う必要がある。

**最終更新:** 2025年10月20日

**1. プロジェクトの初期設定と基盤構築**
*   Reactプロジェクトの新規作成 (`historio-web`ディレクトリ内)。
*   `package.json`に`"homepage": "."`設定を追加し、オフライン/ポータブルビルドに対応。
*   `uuid`ライブラリをインストールし、カードインスタンスにユニークIDを付与可能に。
*   `src/gameLogic` ディレクトリを作成し、コアロジック関連のファイルを格納。
*   主要な定数 (`src/gameLogic/constants.js`) とユーティリティ関数 (`src/gameLogic/gameUtils.js`) をPython版から移植。
*   UIコンポーネントの分離: `App.js`から`Game.js`, `Card.js`, `Hand.js`, `Field.js`, `PlayerStats.js`を独立したファイルに分割。

**2. ゲームの基本フローとコアロジック**
*   **勝利・敗北条件の実装:** 意識が0になった場合、またはデッキが0枚になった場合の勝敗判定ロジックを`src/gameLogic/main.js`に実装。ゲーム終了時には結果画面がUIに表示される。
*   **カードプレイ:** `playCard`関数で、手札からカードをプレイし、関連するトリガー（`PLAY_EVENT_THIS`など）を効果キューに追加するロジックを実装。
*   **ターン進行:** `startTurn` `endTurn`関数で、カードドロー、ターンプレイヤーの交代、および「ターン開始」「ターン終了」イベントの発行を行う。
*   **規模（Scale）の仕様に関する注記:** カードをプレイする際、プレイヤーの現在の規模がカードの必要規模以上である必要がありますが、規模は**消費されません**。規模の増減は、すべてカードの効果によって処理されます。

**3.【重要】汎用リアクションシステムの実装**
*   Python版のアーキテクチャに合わせ、効果処理システムを全面的にリファクタリング。
*   **`processEffects`のメインループ化:** `src/gameLogic/effectHandler.js`の`processEffects`を、`gameState.effect_queue`を監視し、キューが空になるまで効果を処理し続けるゲームのメインループとして再設計。
*   **リアクション機構の導入:** `checkAllReactions`関数を導入。一つの効果が処理された直後、全カードが持つトリガー定義を走査し、発動すべきリアクション効果を自動的にキューの先頭に追加する仕組みを構築。
*   **イベント駆動化:** `src/gameLogic/main.js`の各関数 (`playCard`, `startTurn`等) は、個別の効果を直接実行するのではなく、「ターン開始」のような抽象的なイベントを効果キューに追加するだけのシンプルな役割に変更。これにより、ロジックの関心を分離し、拡張性を大幅に向上させた。

**4. ユーザーインタラクション (選択) の実装**
*   `gameState.awaiting_input`を利用した、汎用的なユーザー選択システムを構築。
*   `resolveInput`関数 (`src/gameLogic/main.js`) と`Game.js`コンポーネントが連携し、以下の選択タイプに対応:
    *   `CHOICE_CARD_TO_ADD`: カード名のリストから1枚を選んで手札に加える選択。
    *   `CHOICE_CARD_FROM_PILE`: 特定の山札にあるカードインスタンスのリストから1枚を選んで指定の場所に移動させる選択。
    *   `CHOICE_CARD_FOR_EFFECT`: 場のカードなどを対象として選択し、特定効果を発動させるための汎用的な選択。
    *   `CHOICE_CARDS_FOR_OPERATION`: `PROCESS_CARD_OPERATION`内で複数カードを選択するための汎用的な選択。
    *   `CHOICE_NUMBER`: `NumberInput.js`コンポーネントを介して、特定の範囲内の数値をユーザーが入力する選択。

**5. 実装済み効果ハンドラ (`src/gameLogic/effectHandler.js`)**
*   **パラメータ変更:** `MODIFY_CONSCIOUSNESS`, `MODIFY_SCALE`, `SET_CONSCIOUSNESS`, `SET_SCALE`, `MODIFY_CARD_DURABILITY`, `MODIFY_CARD_REQUIRED_SCALE`, `MODIFY_FIELD_LIMIT`
*   **カード操作:** `ADD_CARD_TO_GAME` (複数枚追加対応済み), `MOVE_CARD` (random挿入対応済み), `REMOVE_CARD_FROM_GAME`, `WEALTH_DURABILITY_ZERO_THIS` (カード破壊), `SET_CARD_DURABILITY`
*   **効果への介入:**
    *   `SKIP_EFFECT`: 特定の効果を一度だけ無効化する。
    *   `ADD_MODIFY_PARAMETER_CORRECTION`: `MODIFY_`系効果の数値を、指定のルール（減衰、上限など）に基づいて動的に変更する。
*   **プロセス系（複合効果）:**
    *   `PROCESS_CARD_OPERATION` (Python版の設計思想に沿ってリファクタリング済み)
        *   **対応操作 (operation):** `modify_durability`, `modify_required_scale`, `move_card`, `remove`, `generate_card`
        *   **対応選択方法 (selection_method):** `all`, `random`, `highest_required_scale`, `choice` (UI連携済み)
    *   `PROCESS_ALL_WEALTH_BOOST`
    *   `PROCESS_DISCARD_ALL_HAND_WEALTH_CARDS_AND_DRAW`
    *   `PROCESS_CHOOSE_AND_DISCARD_IDEOLOGY`
    *   `PROCESS_RETURN_LARGEST_REQUIRED_SCALE_CARD_TO_DECK`
    *   `PROCESS_COUNTER_ATTACK` (反撃)
    *   `PROCESS_ADD_CARDS_BASED_ON_DISCARDED_COUNT` (捨て札枚数に応じてカードを追加)
    *   `PROCESS_ADD_CHOICE_CARD_TO_HAND` (選択肢からカードを追加)
    *   `PROCESS_CHOOSE_AND_MOVE_CARD_FROM_PILE` (山札から選択してカードを移動)
    *   `PROCESS_CHOOSE_AND_MODIFY_DURABILITY_TO_WEALTH` (場の財を選択して耐久値を変更)
    *   `PROCESS_DRAW_RANDOM_CARD_AND_MODIFY_REQUIRED_SCALE`
    *   `PROCESS_CHOOSE_AND_BOUNCE_TO_WEALTH`
    *   `PROCESS_DISCARD_ALL_HAND_IDEOLOGY_AND_ADD_MONEY`
    *   `PROCESS_SET_ALL_SCALE_TO_ZERO_AND_REDUCE_CONSCIOUSNESS`
    *   `PROCESS_MONEY_CARD_PLACEMENT_EFFECT`
    *   `PROCESS_MONEY_CARD_TURN_START_EFFECT`
    *   `PROCESS_DISCARD_ALL_HAND_IDEOLOGY_AND_ADD_MONEY`
    *   `PROCESS_REDUCE_MONEY_DURABILITY_AND_GAIN_SCALE` (UI側で数値指定をできる仕組みが必要。数字を上下ボタンで増減(初期値0)し確定ボタンを押す。というようなものを想定)
    *   `PROCESS_MODIFY_MONEY_DURABILITY_RANDOM`
    *   `PROCESS_ADD_MONEY_TOKEN_BASED_ON_CARDS_PLAYED`
    *   `PROCESS_MONEY_DURABILITY_BASED_COUNT_MODIFY_CARD_DURABILITY`
    *   `PROCESS_MOVE_RANDOM_CARD_BY_TYPE`
    *   `PROCESS_PLAYER_CHOICE_CARD_MODIFICATION`
    *   `PROCESS_EXPOSE_CARD_BY_TYPE`

**6. 【重要】効果発行の予約パターン**
*   以下の3つの効果は、効果処理の間に他の効果（リアクションなど）を挟む余地を作るため、直接キューに追加してはいけません。
    *   `MODIFY_CONSCIOUSNESS`
    *   `MODIFY_SCALE`
    *   `MODIFY_CARD_DURABILITY`
*   これらの効果を発行したい場合は、必ず対応する `_RESERVE` 版の効果（例: `MODIFY_CONSCIOUSNESS_RESERVE`）を代わりにキューに追加してください。
*   `_RESERVE` ハンドラは、受け取った引数をそのままに、対応する本来の効果（`MODIFY_CONSCIOUSNESS`など）をキューの先頭に積む役割を担います。

**7. これまでの作業と現在のタスク**
*   **完了:** `PROCESS_CARD_OPERATION` の `selection_method` をさらに拡張する（例: `lowest_durability`、`top`、`bottom`など、Python版の全仕様を移植）。
*   **完了:** `MOVE_CARD` 操作に `maintain` オプションを追加し、カードの状態維持を制御できるようにする（Python版の仕様に準拠）。
*   **完了:** `PROCESS_DEAL_DAMAGE_TO_ALL_WEALTH` を使用しているカード定義を `PROCESS_CARD_OPERATION` を使用するように書き換え。
*   **完了:** 未実装だった `PROCESS_DRAW_RANDOM_CARD_AND_MODIFY_REQUIRED_SCALE` ハンドラを `effectHandler.js` に実装。
*   **完了:** `PROCESS_MOVE_HAND_WEALTH_TO_DECK_AND_DRAW`: 実装中 → **完了**
*   **完了:** `PROCESS_EXPOSE_CARD_BY_TYPE`: 実装予定 → **完了**
*   **完了:** `SUCCESS_PROCESS`や`FAILED_PROCESS`を利用しているカードが正しく機能する仕組みが整っているか確認する → **仕組みは整った**
*   **完了:** `card.js`の`checkCardReaction`関数をPython版とほぼ同等に移植完了。
*   **完了:** `constants.js`の`EffectType`と`TriggerType`の定義をPython版と同期完了。
*   **完了:** `effectHandler.js`のキーを`TriggerType`から`EffectType`に修正完了。（`PROCESS_ADD_CARD_CONDITIONAL`, `PROCESS_ADD_CARD_CONDITIONAL_ON_DECK_COUNT`, `PROCESS_ADD_CARDS_BASED_ON_DISCARDED_COUNT`, `PROCESS_ADD_CHOICE_CARD_TO_HAND`, `PROCESS_CHOOSE_AND_MOVE_CARD_FROM_PILE`, `SET_CONSCIOUSNESS`, `SET_SCALE`）
*   **完了:** `effectHandler.js`の未実装ハンドラ（`SET_CARD_DURABILITY`, `PROCESS_MOVE_RANDOM_CARD_BY_TYPE`, `PROCESS_MODIFY_DURABILITY_TO_RANDOM_WEALTH_COUNT`, `PROCESS_PLAYER_CHOICE_CARD_MODIFICATION`）を実装完了。
*   **完了:** 「帝国主義」のテストで発生していた不具合を修正。(`effectHandler.js`の`PROCESS_CARD_OPERATION`における`player_id`および`target_player_id`の解決ロジックを修正)。
*   **完了:** 「砦」カードのテスト（反撃効果）が失敗する問題を修正。
    *   **原因:** ダメージ発生時に発行される `DAMAGE_THIS` トリガーの引数に、ダメージ対象のカードID(`target_card_id`)が含まれておらず、リアクション検知が失敗していた。
    *   **修正:** `effectHandler.js`の`MODIFY_CARD_DURABILITY`ハンドラを修正し、`DAMAGE_THIS`トリガーの引数に`target_card_id`を追加。これにより、リアクションが正しく連鎖するようになった。
    *   **結果:** `tests/test_fortress_effect.js` のテストが成功。
*   **【完了】根本的な不具合の修正とテスト:**
    *   **ステータス:** 完了
    *   **詳細:** `implementation_summary.txt`の【要確認】項目に基づき、複数の根深い問題に対処した。
    *   **1. `TriggerType`と`EffectType`の分離(ただし、Python版の柔軟な効果連鎖を実現することのほうが優先):**
        *   `effectHandler.js`において、アクションを担う`EffectType`と、イベント通知を担う`TriggerType`の役割を明確に分離するリファクタリングを実施。
        *   カード破壊処理を、専用の`WEALTH_DURABILITY_ZERO_THIS`ハンドラから汎用的な`MOVE_CARD`エフェクトに責務を移譲した。
        *   `MODIFY_FIELD_LIMIT`のハンドラキーを`TriggerType`から`EffectType`に修正し、定義と実装を一致させた。
    *   **2. 暗黙的な引数不足の修正:**
        *   `checkCardReaction`のロジックを分析し、`_OPPONENT`系トリガーが正しく機能しないバグを発見。
        *   `MOVE_CARD`ハンドラ内で、相手プレイヤー向けのトリガー（`PLAY_EVENT_OPPONENT`など）を発行する際に、`target_player_id`が正しく相手プレイヤーに設定されるよう修正した。
        *   `PROCESS_CARD_OPERATION`ハンドラで`target_player_id`が指定されていない場合に`player_id`をフォールバックとして使用するよう修正。これにより「聖なる領域」などのカードが正しく動作するようになった。
    *   **3. `awaiting_input`が失われる問題の修正:**
        *   `endTurn`などの関数内で`processEffects`が連鎖的に呼び出され、入力待ち状態が無視される問題を特定。
        *   `main.js`内の`processEffects`呼び出しの直後、`awaiting_input`がセットされている場合は即座に関数を抜けてstateを返すように修正した。
    *   **4. 条件付き効果の判定タイミングの修正:**
        *   `PROCESS_ADD_CARD_CONDITIONAL`のような効果が、トリガー発生時点ではなく効果処理時点のゲーム状態で条件を判定していたため、意図しない挙動となっていた問題を特定。
        *   `checkCardReaction`内で直接条件を判定するようにロジックを移し、問題を解決。これに伴い、`effectHandler.js`から不要になったハンドラを削除。
    *   **5. `endTurn`と`startTurn`の連携修正:**
        *   **問題:** `endTurn`関数がターン終了時の効果を完全に処理する前に、次のターンを開始してしまう問題があった。
        *   **対応:** `main.js`の`endTurn`関数内のループ処理を改善。さらに、テストコード(`test_path_to_enlightenment_effect.js`)側で`endTurn`呼び出し後に`processEffects`をループさせる「ミニ・メインループ」を実装。最終的に、テストコードの期待値が`+2`ではなく`+1`が正しいことを突き止め、テストを成功させた。
        *   **補足:** `App.js`にも`useEffect`を用いたゲームのメインループが欠けていたため、これを実装し、実際のアプリケーションでも効果が正しく連鎖するように修正した。
*   **【完了】基本仕様の同期:**
    *   **ステータス:** 完了
    *   **詳細:** Python版のコードと比較し、ゲーム開始時の基本仕様に差異があることが判明したため、JS版を修正。
    *   **1. 先行/後攻のルール:**
        *   **問題:** JS版では常にPlayer1が先行になっていた。
        *   **修正:** `main.js`の`initializeGame`を修正し、Python版と同様に先行プレイヤーが**ランダム**に決定されるようにした。
    *   **2. 先行デバフ:**
        *   **問題:** Python版に存在する「先行プレイヤーの意識を-3する」デバフが未実装だった。
        *   **修正:** `initializeGame`に処理を追加し、先行プレイヤーの意識が3減少するようにした。
    *   **3. 初期手札とドロータイミング:**
        *   **問題:** 初期手札の枚数と、ターン開始時のドロータイミングがPython版と異なっていた。
        *   **修正:** `constants.js`の`INITIAL_HAND_SIZE`を`3`に変更。`main.js`の`startTurn`の処理順序を変更し、`effectHandler.js`に`DRAW_CARD`ハンドラを追加。これにより、ターン開始時にまずカードを1枚ドローし、その後にターン開始時効果が処理されるようになった。
*   **【完了】「重金主義」カードの不具合修正:**
    *   **ステータス:** 完了
    *   **詳細:** 「重金主義」のテストが失敗する問題に対処。
    *   **1. `TriggerType`と`EffectType`の混同:**
        *   **問題:** `effectHandler.js`において、`SKIP_EFFECT`のハンドラが`TriggerType`として誤って登録されていたため、効果がスキップされない不具合が発生していた。
        *   **修正:** ハンドラのキーを`EffectType.SKIP_EFFECT`に修正し、正しくハンドラが呼び出されるようにした。
    *   **2. `_RESERVE`系効果のキューイング順序:**
        *   **問題:** `MODIFY_SCALE_RESERVE`などのハンドラ内で、トリガーよりも先に実際の効果変更がキューに追加されてしまい、リアクション（特に`SKIP_EFFECT`）が正しく機能しない問題があった。
        *   **修正:** エフェクトキューに追加する順序を修正し、トリガーが常に先に評価されるように変更した。
    *   **結果:** 上記の修正により、「重金主義」カードのテストがすべて成功した。
*   **【完了】「重農主義」カードの不具合修正:**
    *   **ステータス:** 完了
    *   **詳細:** 「重農主義」のテストが失敗する問題に対処。
    *   **1. `test_physiocracy_effect.js`のインポート修正:**
        *   **問題:** `test_physiocracy_effect.js`で`processEffects`関数が`main.js`から誤ってインポートされていたため、`ReferenceError`が発生していた。
        *   **修正:** `processEffects`を`effectHandler.js`から正しくインポートするように修正した。
    *   **2. `MODIFY_CARD_DURABILITY_RESERVE`ハンドラの`card_id`解決:**
        *   **問題:** 「重農主義」のカード定義で`card_id`に指定されていた特殊な文字列`self_money_on_field`が`MODIFY_CARD_DURABILITY_RESERVE`ハンドラで解決されていなかったため、対象の「マネー」カードが見つからず、耐久値が変更されない問題が発生していた。
        *   **修正:** `MODIFY_CARD_DURABILITY_RESERVE`ハンドラに、`self_money_on_field`を`sourceCard`の所有者の場の「マネー」カードの`instance_id`に解決するロジックを追加した。
    *   **3. `MODIFY_CARD_DURABILITY`ハンドラの`SUCCESS_PROCESS`/`FAILED_PROCESS`発行:**
        *   **問題:** `MODIFY_CARD_DURABILITY`ハンドラが、Python版と異なり、処理の成功/失敗を示す`SUCCESS_PROCESS`/`FAILED_PROCESS`トリガーを発行していなかったため、「重農主義」のドロー効果が発動しなかった。
        *   **修正:** `MODIFY_CARD_DURABILITY`ハンドラに、対象カードが見つかった場合は`SUCCESS_PROCESS`を、見つからなかった場合は`FAILED_PROCESS`をキューに追加するロジックを追加した。
    *   **結果:** 上記の修正により、「重農主義」カードのテストがすべて成功した。

**8. カードの能力確認のためのテスト作成と一次検証(二次検証は"test_status_report(historio-web\test_status_report.md)"に記載)**
*   **テスト実行について:** テストの実行は人間が対応し、結果をhistorio-web/src/test_result.txtに貼り付けること。
*   **カード別テスト状況:**
    *   **解体:**
        *   **ステータス:** 完了
        *   **詳細:** 未確認カードリストの「解体」のテストを作成し、成功させた。テスト実行の過程で、複数の根本的な問題が発覚し、それらを修正した。
        *   **1. テスト環境の整備:** JSテストファイルを`historio-web/src/tests`に集約。テストが特定のプリセットデッキに依存しないよう、`initializeGame`を使わないテストヘルパー関数 (`createTestGameState`) を作成する方式に切り替え。テストコードをJestの標準的な`describe/test`形式にリファクタリングし、安定性を向上させた。
        *   **2. コアロジックのバグ修正:** `constants.js`にカードの場所を示す`Location`定数が欠落していた問題を発見し、追加した。また、`effectHandler.js`の`_selectCards`関数が、カード選択（`choice`）の結果（カードIDの配列）を正しく処理できていなかったバグを修正し、カードオブジェクトの配列を返すようにした。
        *   **結果:** 上記の修正を経て、「解体」カードのテストが正常に成功した。
    *   **資本主義:**
        *   **ステータス:** 完了
        *   **詳細:** ターン開始時・終了時の効果が正しく動作しない不具合を修正。
        *   **1. ターン終了時効果の修正:**
            *   **問題:** 耐久値を強化する効果（`PROCESS_MONEY_DURABILITY_BASED_COUNT_MODIFY_CARD_DURABILITY`）の対象に、捨て札になるはずの「マネー」カード自身が含まれてしまい、意図した通りに他の財カードが強化されない。
            *   **修正:** `effectHandler.js` の当該ハンドラを修正し、効果の対象をフィルタリングする際に「マネー」カードを除外するようにした。
            *   **再修正:** `effectHandler.js` の当該ハンドラを修正し、「マネー」の除外をPython版の実装に合わせて戻した。(耐久値強化効果の対象に「マネー」自身を含み、ランダムに強化効果が"実質的に失われる"状態を意図的に作るため)
        *   **2. ターン開始時効果の修正:**
            *   **問題:** ダメージ処理後の正しい合計耐久値で「マネー」を生成できず、常にずれた値が設定されていた。
            *   **原因:** `card.js` の `checkCardReaction` 関数が、責務を越えて `initial_durability` 引数を不完全な状態で数値に解決（計算）してしまっていた。
            *   **修正:** `card.js` から、この不要な引数解決ロジックを削除。これにより、`initial_durability` の計算は、責務通り `ADD_CARD_TO_GAME` ハンドラが、すべてのダメージ処理完了後に実行するようになった。
        *   **結果:** 両方のテストが成功。
    *   **完了 (修正なし):** 「果実」、「農民」、「開拓民」、「豊作」、「覚醒」、「戦士」、「山」、「砦」、「略奪」、「物々交換」、「接収」、「経済学の興り」、「多文化主義」、「帝国主義」、「多神教」、「受難」、「崇拝」、「開拓」、「焦土」、「占領」
        *   **状況:** テスト成功。
    *   **重金主義:**
        *   **ステータス:** 完了
        *   **状況:** 全てのテストが成功。
    *   **重商主義:**
        *   **ステータス:** 完了
        *   **状況:** 全てのテストが成功。
    *   **重農主義:**
        *   **ステータス:** 完了
        *   **状況:** 全てのテストが成功。
    *   **大嵐:**
        *   **ステータス:** 完了
        *   **状況:** 動作検証完了。
        *   **修正:** 古い効果定義 `PROCESS_DEAL_DAMAGE_TO_ALL_WEALTH` が機能しない問題を、`effectHandler.js`でラッパーとして動作するよう修正。
    *   **予感:**
        *   **ステータス:** 完了
        *   **状況:** 動作検証完了。
        *   **修正:** `card_id: 'draw_from_deck'` が機能しない問題を、`effectHandler.js`の`MOVE_CARD`ハンドラに特殊ロジックを追加して解決。
    *   **内部崩壊:**
        *   **ステータス:** 完了
        *   **状況:** 動作検証完了。
        *   **修正:** `MODIFY_SCALE_RESERVE`と`MODIFY_CONSCIOUSNESS_RESERVE`が特定の計算に対応していなかった不具合を修正。
    *   **秩序の瓦解:**
        *   **ステータス:** 完了
        *   **状況:** 動作検証完了。
        *   **修正:** 未実装だった`PROCESS_CHOOSE_AND_DISCARD_IDEOLOGY`ハンドラを新規追加。
    *   **原始共産制:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。
        *   **修正:** `main.js`の`startTurn`関数が発行するトリガーを`START_TURN`から`START_TURN_OWNER`に変更し、カード定義と一致させた。
    *   **物質主義:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。
        *   **修正:** `card.js`に不足していた条件チェックロジック (`condition_field_wealth_count_ge_3`) を追加。
    *   **救世:**
        *   **ステータス:** 完了
        *   **詳細:** プレイ時効果（意識条件に応じた分岐処理）のテストが成功。
        *   **対応:** `card.js`にハードコードで条件分岐を追加。
    *   **一神教 (Monotheism):**
        *   **ステータス:** 完了
        *   **詳細:** 全てのテストをデバッグし、修正済み。
    *   **聖なる領域:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。
        *   **修正:** `PROCESS_CARD_OPERATION`ハンドラが`target_player_id`を必要とするにも関わらず、カード定義側で指定されていなかったため、効果の対象プレイヤーが見つからず処理が失敗していた。ハンドラを修正し、`target_player_id`が未指定の場合は`player_id`をフォールバックとして使用するように変更して解決。
    *   **聖典:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。
        *   **修正:** テストコード側で、場に配置したカードの`location`プロパティを設定していなかったため、効果発動の前提条件を満たせずテストが失敗していた。テストコードを修正し、`location`を正しく設定するように変更して解決。
    *   **布教:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。
        *   **修正:** `PROCESS_ADD_CARD_CONDITIONAL`ハンドラが、トリガー発生時点ではなく効果処理時点のゲーム状態で条件を判定していたため、意図しない挙動となっていた。`checkCardReaction`内で直接条件を判定するようにロジックを移し、問題を解決。
    *   **悟りの道 (Path to Enlightenment):**
        *   **ステータス:** 完了
        *   **状況:** 全てのテストが成功。

*   **完了:** 「植民地」のテストを修正し、成功。
*   **完了:** 「商人」のテストを作成し、成功。
*   **完了:** 「移民」のテストを作成し、成功。
*   **完了:** 「ディアスポラ」のテストを作成し、成功。
*   **完了:** 「内戦」のテストを作成し、成功。
*   **完了:** 「技術革新」のテストを作成し、成功。
*   **完了:** 「技術提供」のテストを作成し、成功。
*   **完了:** 「理想主義」のテストを修正し、成功。
*   **完了:** 「職人」のテストを作成し、成功。
*   **完了:** 「兵器」のテストを修正し、成功。
*   **完了:** 「民族自決」のテストを作成し、成功。

*   **啓蒙時代:**
        *   **ステータス:** 完了
        *   **詳細:** イデオロギーカードの配置に関するJS版とPython版の仕様の差異を修正し、テストを成功させた。
            *   **1. 配置ロジックの統一:** `effectHandler.js`の`ADD_CARD_TO_GAME`と`MOVE_CARD`ハンドラを修正。イデオロギーカードは`player.field`配列ではなく`player.ideology`プロパティに格納し、論理的な`location`は`'field'`に設定するよう統一した。
            *   **2. 移動元（source）の修正:** `MOVE_CARD`ハンドラで、`source_pile`が`'field'`の場合に`player.ideology`からもカードを削除するように修正した。
            *   **3. 選択肢の取得元を修正:** `PROCESS_CHOOSE_AND_MOVE_CARD_FROM_PILE`ハンドラで、`source_piles`に`discard_pile`が指定された場合に`discard`に読み替える処理を追加した。
            *   **4. テストコードの修正:** テストのセットアップを正しいゲーム状態（`player.ideology`にカードをセット）に修正し、効果によって変化する選択肢の数を反映するようアサーションを修正した。

*   **資源:**
    *   **ステータス:** 完了
    *   **詳細:** ダメージトリガーからマネーを生成する効果の不具合を修正し、テストを成功させた。
        *   **1. トリガー判定の修正:** `effectHandler.js`の`checkAllReactions`関数にガード節を追加し、`EffectType`がトリガーとして扱われてクラッシュする問題を修正した。
        *   **2. トリガー引数の修正:** `card.js`の`checkCardReaction`関数で、`DAMAGE_THIS`トリガーからダメージ量を取得する際の引数名を`amount`から`damage_amount`に修正した。
        *   **3. triggers起因のクラッシュ修正:** `card.js`の`checkCardReaction`関数に、`card.triggers`自体が存在しない場合を考慮するガード節を追加し、トリガーを持たないカードに対するリアクションチェックでクラッシュする問題を修正した。

*   **資源の発見:**
    *   **ステータス:** 完了
    *   **詳細:** 「資源」カードをランダムなプレイヤーの場に配置する効果の不具合を修正し、テストを成功させた。
        *   **1. テストコードのインポート修正:** `test_discovery_of_resources_effect.js`で`processEffects`関数が`main.js`から誤ってインポートされていたため、`TypeError`が発生していた。`effectHandler.js`から正しくインポートするように修正した。

*   **徴兵:**
        *   **ステータス:** 完了
        *   **詳細:** 「徴兵」のテストを作成し、成功させた。

*   **現実主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「現実主義」のテストを作成。当初、デフォルトドローの仕様誤解によりテストが失敗したが、ユーザーからのフィードバックに基づきテストの期待値を修正し、全てのテストが成功した。

*   **共同体主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「共同体主義」の配置時効果（捨て札枚数に応じた意識増加）と、自身のカードが捨て札になるたびに意識が増加する効果の両方を検証するテストを作成し、成功させた。

*   **コスモポリタニズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「コスモポリタニズム」のターン開始時（互いの意識-3）とターン終了時（条件付きで相手の規模-3）の効果をそれぞれ検証するテストを作成し、成功させた。

*   **思想の弾圧:**
        *   **ステータス:** 完了
        *   **詳細:** 「思想の弾圧」が持つ3つの効果（イデオロギーをデッキに戻す、意識+5、手札のカードの必要規模-5）が正しく発動することを検証するテストを作成し、成功させた。

*   **汎民族主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「汎民族主義」の配置時と、自身の意識が増加した際のリアクション効果を検証するテストを作成し、effectHandler.jsのMODIFY_CONSCIOUSNESS_RESERVEにトリガー発行ロジックを追加して成功させた。

*   **分離主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「分離主義」の配置時効果とリアクション効果を検証するテストを作成し、成功させた。この過程で、以下の複数のコアエンジンにおけるバグが発見・修正された。
            *   **1. `card.js`の条件分岐の修正:** Python版のロジックに基づき、手札に追加されたカードの必要規模を正しくチェックするよう修正。
            *   **2. `effectHandler.js`のトリガー発行漏れの修正:** `ADD_CARD_TO_GAME`ハンドラが、`CARD_ADDED_TO_HAND_OWNER`トリガーを発行していなかったバグを修正。
            *   **3. `effectHandler.js`の引数解決の追加:** `PROCESS_CARD_OPERATION`ハンドラが、`"last_added_card"`という特別な文字列を解決できず、対象カードを特定できないバグを修正。
            *   **4. カード定義の引数名の修正:** テストコード内のカード定義で、移動先を指定する引数が`destination`（誤）となっていたのを`destination_pile`（正）に修正。

*   **不干渉主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「不干渉主義」のテストを作成し、成功させた。この過程で、`MODIFY_CONSCIOUSNESS_RESERVE`ハンドラが、効果対象に関わらず`_OWNER`トリガーしか発行しないバグが発見・修正された。

*   **隘路:**
        *   **ステータス:** 完了
        *   **詳細:** `_OPPONENT`系トリガーの判定ロジックが、アクションの実行者(`player_id`)ではなく、トリガーの対象(`target_player_id`)を見ていたため、意図通りに動作しない不具合があった。`card.js`の`checkCardReaction`関数を修正し、アクションの実行者が相手プレイヤーであることを正しく判定するように変更。テストを作成し、成功を確認した。

*   **工作員:**
        *   **ステータス:** 完了
        *   **詳細:** 相手ターン開始時のトリガー`START_TURN_OPPONENT`が発行されていなかったため、カードの効果が発動しない不具合があった。`main.js`の`startTurn`関数を修正し、`START_TURN_OPPONENT`トリガーを正しく発行するように変更。テストを作成し、成功を確認した。

*   **大地震:**
        *   **ステータス:** 完了
        *   **詳細:** deepCopyを利用している箇所から、使わないように変更を行った。以後はテスト側が監視する箇所自体が誤っていたことが判明し、正しい参照先に合わせたところテストが成功した。

*   **災害多発地域:**
        *   **ステータス:** 完了
        *   **状況:** デバッグログ削除済み。

*   **官僚主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「官僚主義」カードをプレイした際に、相手の手札に移動しない不具合に対処。
        *   **原因:** `effectHandler.js` の `checkAllReactions` 関数が、`playing_event` にあるカードをリアクションの対象として含めていなかったため、カード定義に記述された `PLAY_EVENT_THIS` トリガーが正しく処理されていなかった。
        *   **修正:** `checkAllReactions` 関数を修正し、`sourceCard` が `playing_event` にある場合もリアクションの対象に含めるようにした。
        *   **結果:** 「官僚主義」カードのテストがすべて成功した。

*   **保守主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「保守主義」のテストを作成し、成功させた。
        *   **原因:** effectHandler.js の PROCESS_CARD_OPERATION ハンドラ内で、source_pile が "discard_pile" の場合に player.discard_pile を参照しようとしていたが、player オブジェクトには discard       
            プロパティしか存在しなかったため、捨て札からのカード移動が正しく行われていなかった。
        *   **修正:** PROCESS_CARD_OPERATION ハンドラ内で、source_pile および source_piles の "discard_pile" を "discard" に正規化するように修正した。
        *   **結果:** 「保守主義」カードのテストがすべて成功した。

*   **環境主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「環境主義」のテストを作成し、成功させた。この過程で、`_RESERVE`系の効果処理に関するアーキテクチャレベルの修正を行った。
        *   **1. `_RESERVE`系トリガーの標準化:** `MODIFY_CARD_DURABILITY_RESERVE`ハンドラが、他の`_RESERVE`系（意識、規模）ハンドラと異なり、リアクションの起点となる`TriggerType`       
            を発行していなかった。これにより、カードの耐久値変更に対するリアクションが機能しない問題があった。
        *   **修正:** `constants.js`に耐久値変更用の新しい`TriggerType`（`MODIFY_CARD_DURABILITY_DECREASE_RESERVE_OWNER`など）を追加。`effectHandler.js`の
            `MODIFY_CARD_DURABILITY_RESERVE`ハンドラを修正し、これらのトリガーを発行するようにした。
        *   **2. テストコードの修正:** テストが、変更されない`durability`プロパティではなく、実際に変更される`current_durability`
            プロパティを正しく監視するようにアサーションを修正した。

*   **リージョナリズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「リージョナリズム」のテストを作成し、成功させた。テスト初期に、カードプレイに必要な規模が足りず失敗したが、テストの初期状態を修正して解決した。

*   **社会主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「社会主義」のテストが失敗する問題を修正。
            *   **原因:** `effectHandler.js`の`_selectCards`関数が、`selection_method: 'lowest_durability'`の際に`count`が指定されていないと、対象を1枚に絞らず全てのカードを返していた。
            *   **修正:** `_selectCards`を修正し、`lowest_durability`で`count`が未指定の場合はデフォルトで1枚のカードを選択するように変更。
            *   **結果:** 「社会主義」のテストがすべて成功した。

*   **アナーキズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「アナーキズム」のテストを作成し、事象カードプレイ時の効果が発動しない不具合を修正した。
            *   **原因:** `main.js`の`playCard`関数が、事象カードプレイ時に`PLAYER_ACTION`を発行せず、直接`MOVE_CARD`エフェクトを発行していたため、`PLAY_EVENT_OWNER`トリガーが発行されていなかった。
            *   **修正:** `main.js`の`playCard`関数をリファクタリングし、カードの種類に関わらず一律で`PLAYER_ACTION`を発行するように修正。これにより、`effectHandler.js`の`PLAYER_ACTION`ハンドラが一元的に処理を行うようになり、事象カードプレイ時にも正しいトリガーが発行されるようになった。
            *   **結果:** 「アナーキズム」のテストがすべて成功した。

*   **結束主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「結束主義」のテストを作成し、修正なしで成功した。配置時、ターン開始時、相手の意識減少時のすべての効果が、既存のエンジン機能で正しく動作することを確認した。

*   **記憶の浄化:**
        *   **ステータス:** 完了
        *   **詳細:** 「記憶の浄化」のテストを作成し、成功させた。当初、Jest環境と`gameState`の参照問題に起因すると思われる稀なバグにより、ロジックは正しく動作しているにも関わらずアサーションが失敗した。
            *   **原因:** `processEffects`ループ後の`gameState`が、非同期的なタイミングの問題で、最終的な変更を反映する前の状態を参照してしまっていた。
            *   **修正:** 問題を回避するため、`effectHandler.js`の`REMOVE_CARD_FROM_GAME`ハンドラにグローバルなテスト用コールバックフック(`global.testHooks.onCardRemoved`)を追加。テストコード側では、最終的な捨て札の枚数を数えるのではなく、このフックが期待通り3回呼び出されたことをアサートする方法に変更。これにより、`gameState`の状態に依存せず、アクションの実行そのものを直接検証できるようにし、テストを成功させた。

*   **軍国主義:**
        *   **ステータス:** 完了
        *   **詳細:** リアクション効果が過剰に発動する不具合を修正し、テストを成功させた。
            *   **原因:** 従来の実装では、`card.js`の`checkCardReaction`関数が、`_OPPONENT`や`_THIS`といった具体的なトリガーから、定義にない汎用トリガー（例: `WEALTH_DURABILITY_ZERO`）を推測して反応する「フォールバック機能」を持っていた。これがPython版の意図せぬ挙動であり、複数のトリガーに重複して反応する根本原因となっていた。
            *   **修正1 (根本対応):** `card.js`から、このフォールバック機能を完全に削除。トリガー名を厳密に一致させる仕様に変更した。
            *   **修正2 (仕様変更への追従):** `effectHandler.js`の`MODIFY_CARD_DURABILITY`ハンドラを修正し、財破壊時に`WEALTH_DURABILITY_ZERO`、`_OWNER`、`_OPPONENT`、`_THIS`といった関連トリガーをすべて明示的に発行するように変更。
            *   **修正3 (クリーンアップ):** 不要になった`WEALTH_DURABILITY_ZERO`ハンドラを削除。
            *   **結果:** 「軍国主義」は、カード定義通り`WEALTH_DURABILITY_ZERO`トリガーにのみ正しく1回反応するようになり、テストが成功した。

*   **孤立主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「孤立主義」のテストを作成し、その過程で発覚した複数の問題を修正した。
            *   **1. 無限ループの発生:** テスト実行時、自爆効果（意識ダメージを受けた際に自身を回復・強化して捨て札になる効果）が、自身の回復効果にまで反応してしまい、無限ループに陥る問題が発覚した。
            *   **2. 原因特定:** 調査の結果、リアクションのトリガー条件判定が、ダメージ軽減などが計算される前の「元のダメージ量」を参照していたため、ダメージが0になるケースでも自爆効果が誤って発動していたことが判明した。
            *   **3. エンジン修正 (最終ダメージ量の参照):** この問題を根本的に解決するため、エンジンの動作を修正。まず、`effectHandler.js`の`MODIFY_CONSCIOUSNESS`ハンドラが、軽減後の「最終的な意識変動量」を一時データ領域(`gameState.temp_effect_data.last_consciousness_change`)に保存するように変更した。
            *   **4. エンジン修正 (条件判定ロジック):** 次に、`card.js`の`checkCardReaction`関数を修正。カード定義ファイルに`condition: { check: 'consciousness_decreased_by_opponent' }`のような汎用的な条件を記述できるようにし、その判定ロジックが上記の一時保存された「最終的な意識変動量」を参照するようにした。
            *   **5. ハードコードの修正:** ユーザーからの指摘に基づき、本番のカード定義ファイルには`condition`プロパティがない場合でも動作するよう、`card.js`内に残っていた古いハードコードのロジックも、この新しい「最終的な意識変動量」を参照する正しい方法に修正した。
            *   **結果:** 上記のエンジン修正と、より正確な境界値テスト（ダメージが0になるケースと残るケース）への見直しを経て、すべてのテストが成功した。

*   **グローバリズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「グローバリズム」のテストを作成し、その過程で発覚した複数の問題を修正した。
            *   **1. バグの発見:** テストの結果、「相手がカードを出すたび」の効果が、自分のカードプレイにも誤って反応してしまうバグが発覚した。また、配置時効果もこのバグの影響で正しい結果になっていなかった。さらに、テストの初期設定（規模不足）も問題だった。
            *   **2. エンジン修正 (条件判定ロジック):** この問題を解決するため、`card.js`の`checkCardReaction`関数に、カードをプレイしたのが相手かどうかを判定する汎用的な条件`is_opponent_play`を追加した。
            *   **3. テストコード修正:** テストファイル内のモック定義で、`PLAYER_PLAY_CARD_ACTION`トリガーにこの新しい`condition`を追加。また、初期規模不足を解消した。
            *   **結果:** 上記の修正により、すべてのテストが成功した。

*   **リバタリアニズム:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。

*   **共産主義:**
        *   **ステータス:** 完了
        *   **状況:** テスト成功。

*   **覇権主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「覇権主義」のテストを作成し、成功させた。この過程で、`main.js`の`resolveInput`関数の呼び出し方が古い仕様のままであるというテストコード側のバグと、`card.js`の`checkCardReaction`関数に`self_money_on_field`という特殊なカードIDを解決するロジックが欠けていたエンジン側のバグの2点を修正した。

*   **多極主義:**
        *   **ステータス:** 完了
        *   **状況:** 全てのテストが成功。

*   **ニューリベラリズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「ニューリベラリズム」のテストを作成し、成功させた。当初、カード効果が正しく発動しているにも関わらずテストが失敗する問題が発生した。
            *   **原因:** テストコードのアサーション（期待値）が、実際の正しい動作と異なっていた。具体的には、手札の枚数をチェックする際に、効果によってカードが1枚引かれることを考慮していなかった。
            *   **修正:** テストコードを修正し、`initialHandSize` を記録するタイミングを、テスト用の「マネー」カードを手札に加えた後に変更。これにより、期待値が正しい値（1枚プレイして1枚引くため、手札の枚数は変わらない）になり、テストが成功した。

*   **ネオリベラリズム:**
        *   **ステータス:** 完了
        *   **詳細:** 「ネオリベラリズム」のテストを作成。当初、ダメージ軽減効果が機能せずテストが失敗した。
            *   **原因:** パラメータ補正（ダメージ軽減など）を計算する `modifyParameterCorrectionCalculation` 関数のロジックが、複数の補正効果を正しく合算・適用できない不完全な実装だった。また、テスト用のモック定義でトリガーの指定（`TriggerType`と`EffectType`の混同）に誤りがあった。
            *   **修正:** Python版の実装を参考に `effectHandler.js` の `modifyParameterCorrectionCalculation` 関数を全面的に書き換え、複数の補正効果（増幅・減衰・上限）を正しく合算し、適用後に消費するロジックに修正。また、`card.js`の`checkCardReaction`ですべてのリアクション効果に`source_card_id`を付与するようにし、`ADD_MODIFY_PARAMETER_CORRECTION`ハンドラもこれを保存するように修正した。
            *   **結果:** 上記のエンジン修正により、カード定義ファイルを変更することなく、テストが成功した。

*   **教育機関:**
        *   **ステータス:** 完了
        *   **詳細:** 「教育機関」のテストを作成。当初、ターン開始時にカードを選択して手札に加える効果が失敗した。
            *   **原因:** awaiting_inputに渡すデータに誤りがあった。
            *   **修正:** 正しいタイプのデータ(配列?)を渡すよう修正を行った。
            *   **結果:** テストコードの修正により、テストが成功した。

    *   **自由主義:**
        *   **ステータス:** 完了
        *   **詳細:** 「自由主義」のテストを作成し、成功させた。この過程で、複数のエンジン側の問題とテストコードの不備が明らかになった。
            *   **1. トリガータイプの不整合:** カードプレイ時に発行されるトリガーが`EffectType`として定義されていたため、`TriggerType`をリッスンしているカードが反応できない問題があった。`constants.js`に`TriggerType.PLAYER_PLAY_CARD_ACTION`を追加し、`effectHandler.js`が正しいトリガーを発行するように修正して解決した。
            *   **2. リアクションの条件判定タイミング:** スケール増加の結果（例：25を超える）に反応する効果が、スケールが実際に変更される**前**に評価されてしまい、正しく動作しない問題があった。これは`_RESERVE`系効果が、リアクションの発動を優先するために、実際の効果より先にトリガーを発行する設計に起因していた。
            *   **修正:** この問題を解決するため、トリガーを`_RESERVE`系（`MODIFY_SCALE_INCREASE_RESERVE_OWNER`）から、実際の効果処理である`EffectType.MODIFY_SCALE`に変更。これにより、スケール変更が完了した**後**の最新のゲーム状態で条件判定が行われるようになった。さらに、`MODIFY_SCALE`ハンドラが最終的なスケール変動量を`gameState.temp_effect_data`に保存し、`checkCardReaction`がその値を参照して「境界値をまたいだ」ことを正確に判定するロジックを追加した。
            *   **3. テストコードの修正:** 最終的に、テストが失敗する原因は、`awaiting_input.options`の内容を誤って検証していたテストコードのアサーションにあることが判明。これを修正し、すべてのテストが成功した。

*   **愛国教育、嫌国教育、文化的影響、文化侵略:**
        *   **ステータス:** 完了
        *   **詳細:** 4枚のカードのテストを作成し、成功させた。「文化的影響」のテストで、手札枚数を検証するロジックに誤りがあったが、これを修正して解決した。

*   **ウルトラナショナリズム:**
        *   **ステータス:** 完了
        *   **詳細:** テストを作成し、その過程でイデオロギーカードの配置時に、配置時効果とカードプレイ時効果が意図せず重複して発動する問題を発見した。`checkCardReaction`関数に、「カードは自分自身がプレイされたアクションには反応しない」というルールを追加することで、この問題を解決し、テストを成功させた。

*   **ポピュリズム:**
        *   **ステータス:** 完了
        *   **詳細:** テストを作成し、成功させた。この過程で、カード定義に記述された`source_pile: "current"`という特別な値をエンジンが解決できていない問題を発見した。`checkCardReaction`関数に、この値をカードの現在位置(`card.location`)に動的に解決する汎用的なロジックを追加することで問題を修正した。

*   **確証破壊能力、相互確証破壊:**
        *   **ステータス:** 完了
        *   **詳細:** 2枚のカードのテストを作成し、成功させた。この過程で、`_getCardsFromPiles` が単一のカードオブジェクト（イデオロギーなど）を正しく処理できないバグと、`checkCardReaction` が `SUCCESS_PROCESS` トリガーから公開されたカードのIDを正しく解決できないバグを発見し、これらを修正した。




**【現在のタスク】**
**現在のタスク:** test_status_report.mdに存在する本番でバグっているテストの修正および再検証を1件ずつ行う(「農民」から)
テストの実行は人間が対応し、結果をhistorio-web/src/test_result.txtに貼り付けます。